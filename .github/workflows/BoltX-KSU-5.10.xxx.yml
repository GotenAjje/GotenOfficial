name: Build GKI BoltX KernelSU-Next

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-22.04

    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          swap-size-mb: 10240
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Setup git identity
        run: |
          git config --global user.name "boltX"
          git config --global user.email "kingfinix98@gmail.com"

      - name: Install Dependencies
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y git curl repo build-essential bc bison flex libssl-dev \
            libelf-dev python3 python3-pip unzip zip rsync libncurses-dev lld

      - name: Create and Init GKI Source (Shallow)
        run: |
          mkdir gki && cd gki
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android12-5.10 --depth=1
          repo sync -c --no-tags --no-clone-bundle --optimized-fetch -j$(nproc --all)

      - name: Delete Line 2 in build.config.gki
        run: |
          if [ -f gki/common/build.config.gki ]; then
            sed -i '2d' gki/common/build.config.gki
          else
            echo "Warning: build.config.gki not found, skipping modification."
          fi

      - name: Apply KernelSU-Next & SUSFS
        run: |
          cd gki/common
          
          # --- 1. Install KernelSU-Next (Branch: next) ---
          echo "Installing KernelSU-Next..."
          # Script setup akan clone repo dan membuat symlink
          curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s next
          
          # --- 2. Clone SUSFS (Branch: gki-android12-5.10) ---
          echo "Cloning SUSFS..."
          git clone https://gitlab.com/simonpunk/susfs4ksu/ -b gki-android12-5.10 sus
          
          # --- 3. Copy SUSFS Files (Safe Method) ---
          cp -r sus/kernel_patches/fs/. fs/
          cp -r sus/kernel_patches/include/. include/
          
          # --- 4. Apply SUSFS Patch ---
          cp sus/kernel_patches/50_add_susfs_in_gki-android12-5.10.patch .
          echo "Applying SUSFS Patch..."
          patch -p1 --fuzz=3 < 50_add_susfs_in_gki-android12-5.10.patch || true

          # --- 5. Setup Submodule & Git State (SOLUSI SUBMODULE) ---
          
          # Deteksi nama folder
          if [ -d "KernelSU-Next" ]; then
            KSU_DIR="KernelSU-Next"
          elif [ -d "KernelSU" ]; then
            KSU_DIR="KernelSU"
          else
            echo "Error: KernelSU folder not found!"
            exit 1
          fi

          echo "Detected KernelSU directory: $KSU_DIR"
          
          # [PENTING] JANGAN HAPUS .git DI DALAM KERNELSU-NEXT
          # Biarkan .git ada agar Makefile bisa baca versi (KSU_VERSION_TAG)
          
          # Hapus .git milik SUSFS saja (SUSFS jadi file biasa)
          rm -rf sus/.git
          
          # Add ke git
          # Git akan otomatis mendeteksi KSU_DIR sebagai 'embedded repository' (submodule)
          git add $KSU_DIR
          git add sus
          
          # Kita commit agar state-nya bersih
          git commit -m "Inject KernelSU-Next (as Submodule) & SUSFS" || true

      - name: Apply Cherry-pick from Pzqqt
        run: |
          cd gki/common
          curl -L https://github.com/Pzqqt/android_kernel_xiaomi_marble/commit/477706c2bcaaf48350c61f9f6824e1e454617147.patch > custom_cherrypick.patch
          
          echo "Applying custom cherry-pick..."
          git apply -v custom_cherrypick.patch || echo "Cherry-pick failed but continuing..."
          
          rm custom_cherrypick.patch
          git add .
          git commit -m "Apply cherry-pick: 477706c" || true

      - name: Add Custom Network & FS Configs
        run: |
          DEFCONFIG="gki/common/arch/arm64/configs/gki_defconfig"
          echo "Injecting custom configs to $DEFCONFIG"
          echo "CONFIG_TMPFS_XATTR=y" >> $DEFCONFIG
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> $DEFCONFIG
          echo "CONFIG_IP_NF_TARGET_TTL=y" >> $DEFCONFIG
          echo "CONFIG_IP6_NF_TARGET_HL=y" >> $DEFCONFIG
          echo "CONFIG_IP6_NF_MATCH_HL=y" >> $DEFCONFIG
          echo "CONFIG_TCP_CONG_ADVANCED=y" >> $DEFCONFIG 
          echo "CONFIG_TCP_CONG_BBR=y" >> $DEFCONFIG
          echo "CONFIG_NET_SCH_FQ=y" >> $DEFCONFIG
          echo "CONFIG_TCP_CONG_BIC=n" >> $DEFCONFIG
          echo "CONFIG_TCP_CONG_WESTWOOD=n" >> $DEFCONFIG
          echo "CONFIG_TCP_CONG_HTCP=n" >> $DEFCONFIG 
          echo "CONFIG_DEFAULT_BBR=y" >> $DEFCONFIG

      - name: Set Kernel Name and Branding (CLEAN)
        run: |
          cd gki/common
          BRAND="-BoltX-KsuXFS"
          
          echo "Branding kernel as $BRAND"
          
          # 1. Hapus logika versioning bawaan linux
          echo "echo \"$BRAND\"" > scripts/setlocalversion
          chmod +x scripts/setlocalversion
          
          # 2. Update config
          DEFCONFIG="arch/arm64/configs/gki_defconfig"
          sed -i '/^CONFIG_LOCALVERSION=/d' "$DEFCONFIG"
          echo "CONFIG_LOCALVERSION=\"$BRAND\"" >> "$DEFCONFIG"
          echo "CONFIG_LOCALVERSION_AUTO=n" >> "$DEFCONFIG"

      - name: Append CONFIG_HZ_300 to defconfig
        run: |
          echo -e '\nCONFIG_HZ_300=y\nCONFIG_HZ=300' >> gki/common/arch/arm64/configs/gki_defconfig

      - name: Final Clean Tree Commit
        run: |
          cd gki/common
          git add .
          git commit -m "Final clean tree before build" || true

      - name: Build Kernel
        run: |
          cd gki
          LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh

      - name: Upload Image to PixelDrain
        if: always() 
        run: |
          if [ -f gki/out/android12-5.10/common/arch/arm64/boot/Image ]; then
            echo "Uploading Image..."
            curl -u :53bc8bf8-584d-444e-97e3-715a1b3526bf \
              -F file=@gki/out/android12-5.10/common/arch/arm64/boot/Image \
              -F name="Image-BoltX-Ksu-Next" \
              https://pixeldrain.com/api/file
          else
            echo "Image file not found. Build likely failed."
            exit 1
          fi
